<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Dicas por Posição - TCC</title>
    <link rel="stylesheet" href="styles.css?v=5.0">
</head>
<body>
    <div class="container">
        <!-- Área de controles -->
        <div class="controls">
            <h1>Gerador de Dicas por Posição - TCC</h1>
            <div class="controls-section">
                <label for="roundNumber">Número da Rodada:</label>
                <input type="number" id="roundNumber" placeholder="Ex: 1, 2, 3..." min="1" max="38">
                
                <label for="fileInput">Carregar Lista de Jogadores:</label>
                <input type="file" id="fileInput" accept=".csv,.txt">
                
                <label for="gatoMestreToken">Refresh Token Gato Mestre (configurar UMA VEZ):</label>
                <input type="text" id="gatoMestreToken" placeholder="Cole o Refresh Token aqui...">
                <button id="saveTokenBtn">Salvar Refresh Token</button>
                <small style="color: #666; display: block; margin-top: 5px;">Após salvar, você nunca mais precisará copiar token!</small>
                
                <button id="updateMarketBtn">Atualizar Mercado</button>
                <button id="generateBtn">Gerar Arte</button>
                
                <div class="export-options">
                    <label for="exportSize">Tamanho da Exportação:</label>
                    <select id="exportSize">
                        <option value="1450x2400">1450×2400 px (Stories)</option>
                        <option value="2900x4800" selected>2900×4800 px (Alta Definição)</option>
                        <option value="4350x7200">4350×7200 px (Ultra HD)</option>
                    </select>
                </div>
                
                <div class="export-buttons" style="display: none;">
                    <button id="downloadPngBtn">Baixar PNG</button>
                    <button id="downloadPdfBtn">Baixar PDF</button>
                    <button id="downloadPdfVectorBtn">Baixar PDF Vetorial</button>
                </div>
                
                <div id="errorMessages" class="error-messages"></div>
            </div>
        </div>

        <!-- Canvas para geração da imagem -->
        <div class="canvas-container">
            <canvas id="artCanvas" width="2900" height="4800"></canvas>
        </div>

        <!-- Layout da arte (2700x4500px) -->
        <div class="art-layout" id="artLayout">
            <!-- Header com logo -->
            <div class="header">
                <img src="TCCBRANCOTRANSPARENTE.png" alt="TCC Logo" class="logo">
                <h1 class="title" id="artTitle">DICAS POR POSIÇÃO - TCC</h1>
            </div>

            <!-- Grid com 6 blocos de posições -->
            <div class="positions-grid">
                <!-- Técnicos -->
                <div class="position-block">
                    <div class="position-header">
                        <h2>TÉCNICOS</h2>
                        <div class="header-labels">
                            <span>C</span>
                            <span>C$</span>
                            <span>MPV</span>
                        </div>
                    </div>
                    <div class="players-list" id="tecnicos">
                        <!-- Jogadores serão inseridos aqui via JavaScript -->
                    </div>
                </div>

                <!-- Goleiros -->
                <div class="position-block">
                    <div class="position-header">
                        <h2>GOLEIROS</h2>
                        <div class="header-labels">
                            <span>C</span>
                            <span>C$</span>
                            <span>MPV</span>
                        </div>
                    </div>
                    <div class="players-list" id="goleiros">
                        <!-- Jogadores serão inseridos aqui via JavaScript -->
                    </div>
                </div>

                <!-- Laterais -->
                <div class="position-block">
                    <div class="position-header">
                        <h2>LATERAIS</h2>
                        <div class="header-labels">
                            <span>C</span>
                            <span>C$</span>
                            <span>MPV</span>
                        </div>
                    </div>
                    <div class="players-list" id="laterais">
                        <!-- Jogadores serão inseridos aqui via JavaScript -->
                    </div>
                </div>

                <!-- Zagueiros -->
                <div class="position-block">
                    <div class="position-header">
                        <h2>ZAGUEIROS</h2>
                        <div class="header-labels">
                            <span>C</span>
                            <span>C$</span>
                            <span>MPV</span>
                        </div>
                    </div>
                    <div class="players-list" id="zagueiros">
                        <!-- Jogadores serão inseridos aqui via JavaScript -->
                    </div>
                </div>

                <!-- Meias -->
                <div class="position-block">
                    <div class="position-header">
                        <h2>MEIAS</h2>
                        <div class="header-labels">
                            <span>C</span>
                            <span>C$</span>
                            <span>MPV</span>
                        </div>
                    </div>
                    <div class="players-list" id="meias">
                        <!-- Jogadores serão inseridos aqui via JavaScript -->
                    </div>
                </div>

                <!-- Atacantes -->
                <div class="position-block">
                    <div class="position-header">
                        <h2>ATACANTES</h2>
                        <div class="header-labels">
                            <span>C</span>
                            <span>C$</span>
                            <span>MPV</span>
                        </div>
                    </div>
                    <div class="players-list" id="atacantes">
                        <!-- Jogadores serão inseridos aqui via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <div class="legend">
                    <div class="legend-item">
                        <img src="public/icons/luxo.svg" alt="RL" class="icon">
                        <span>RL - luxo</span>
                    </div>
                    <div class="legend-item">
                        <img src="public/icons/estrela.svg" alt="Unanimidade" class="icon">
                        <span>Unanimidade</span>
                    </div>
                    <div class="legend-item">
                        <img src="public/icons/confA.svg" alt="Nível A" class="icon">
                        <span>Nível de confiança</span>
                    </div>
                    <div class="legend-item">
                        <img src="public/icons/capitao.svg" alt="Capitão" class="icon">
                        <span>Bom capitão</span>
                    </div>

                </div>
                <p class="footer-text">CONTEÚDO EXCLUSIVO - TCC</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="script.js?v=3.0"></script>
 <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

    <button id="baixar-imagem" style="position:fixed;right:16px;bottom:16px;z-index:9999;padding:10px 14px;background:#0b5;color:#fff;border:none;border-radius:8px;cursor:pointer">Baixar imagem</button>
    <script>
      async function baixarPagina() {
        const target = document.querySelector('#artLayout') || document.body;

        const imgs = Array.from(document.querySelectorAll('img'));
        const nodes = Array.from(document.querySelectorAll('*'));

        imgs.forEach(img => {
          img.setAttribute('crossorigin', 'anonymous');
          if (img.src.startsWith('http') && !img.src.includes(location.origin)) {
            const proxied = `${location.origin}/.netlify/functions/img-proxy?url=${encodeURIComponent(img.src)}`;
            img.setAttribute('data-original-src', img.src);
            img.src = proxied;
          }
        });

        const urlFromBg = s => {
          const v = s.backgroundImage || '';
          const m = v.match(/url\((?:'|")?(.*?)(?:'|")?\)/i);
          return m && m[1] ? m[1] : null;
        };

        nodes.forEach(n => {
          const s = getComputedStyle(n);
          const bgUrl = urlFromBg(s);
          if (bgUrl && bgUrl.startsWith('http') && !bgUrl.includes(location.origin)) {
            const proxied = `${location.origin}/.netlify/functions/img-proxy?url=${encodeURIComponent(bgUrl)}`;
            n.setAttribute('data-original-bg', s.backgroundImage);
            n.style.backgroundImage = `url(${proxied})`;
          }
          if (s.filter && s.filter !== 'none') n.style.filter = 'none';
          if (s.mixBlendMode && s.mixBlendMode !== 'normal') n.style.mixBlendMode = 'normal';
          if (s.backdropFilter && s.backdropFilter !== 'none') n.style.backdropFilter = 'none';
        });

        const dataUrl = await htmlToImage.toPng(target, {
          cacheBust: true,
          pixelRatio: 2,
          canvasWidth: target.scrollWidth,
          canvasHeight: target.scrollHeight
        });

        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = 'dica-cartola.png';
        a.click();

        imgs.forEach(img => {
          const orig = img.getAttribute('data-original-src');
          if (orig) {
            img.src = orig;
            img.removeAttribute('data-original-src');
          }
        });

        nodes.forEach(n => {
          const origBg = n.getAttribute('data-original-bg');
          if (origBg) {
            n.style.backgroundImage = origBg;
            n.removeAttribute('data-original-bg');
          }
          n.style.filter = '';
          n.style.mixBlendMode = '';
          n.style.backdropFilter = '';
        });
      }

      document.getElementById('baixar-imagem').addEventListener('click', baixarPagina);
    </script>
</body>
</html>
</body>
</html>
